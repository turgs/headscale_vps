name: Deploy DNS Filters

on:
  push:
    branches:
      - main
    paths:
      - 'config/dns-allowlist.txt'
      - 'config/dns-blocklist.txt'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual deployment)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy DNS Configuration
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy
        run: |
          set -euo pipefail
          
          # Load VPS configuration from config file
          if [[ ! -f config/vps-config.txt ]]; then
            echo "ERROR: config/vps-config.txt not found"
            exit 1
          fi
          
          source config/vps-config.txt
          
          # Validate required variables
          if [[ -z "${VPS_DOMAIN:-}" ]]; then
            echo "ERROR: VPS_DOMAIN not set in config/vps-config.txt"
            exit 1
          fi
          if [[ -z "${SSH_PORT:-}" ]]; then
            echo "ERROR: SSH_PORT not set in config/vps-config.txt"
            exit 1
          fi
          if [[ -z "${SSH_USER:-}" ]]; then
            echo "ERROR: SSH_USER not set in config/vps-config.txt"
            exit 1
          fi
          
          # Create temporary SSH key file
          KEY_FILE=$(mktemp)
          trap "rm -f $KEY_FILE" EXIT
          
          echo "${{ secrets.VPS_SSH_KEY }}" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          
          # Build arguments from config file
          ARGS="--host=$VPS_DOMAIN --ssh-key=$KEY_FILE --ssh-port=$SSH_PORT --ssh-user=$SSH_USER"
          [[ "${{ inputs.dry_run }}" == "true" ]] && ARGS="$ARGS --dry-run"
          
          ./scripts/deploy-dns.sh $ARGS
