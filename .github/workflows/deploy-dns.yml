name: Deploy DNS Filters

on:
  push:
    branches:
      - main
    paths:
      - 'config/dns-allowlist.txt'
      - 'config/dns-blocklist.txt'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual deployment)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy DNS Configuration
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          # Disable strict host key checking for automated deployment
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
      
      - name: Validate DNS configuration files
        run: |
          echo "Validating DNS configuration files..."
          
          # Check if files exist
          if [[ ! -f config/dns-allowlist.txt ]]; then
            echo "ERROR: config/dns-allowlist.txt not found"
            exit 1
          fi
          
          if [[ ! -f config/dns-blocklist.txt ]]; then
            echo "ERROR: config/dns-blocklist.txt not found"
            exit 1
          fi
          
          # Count domains (excluding comments and empty lines)
          allowlist_count=$(grep -v '^#' config/dns-allowlist.txt | grep -v '^[[:space:]]*$' | wc -l || echo "0")
          blocklist_count=$(grep -v '^#' config/dns-blocklist.txt | grep -v '^[[:space:]]*$' | wc -l || echo "0")
          
          echo "Allowlist domains: $allowlist_count"
          echo "Blocklist domains: $blocklist_count"
          
          # Validate domain format (basic check)
          if grep -Ev '^(#.*|[[:space:]]*|[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*.*)$' config/dns-allowlist.txt | grep -v '^[[:space:]]*$'; then
            echo "ERROR: Invalid domain format in allowlist"
            exit 1
          fi
          
          if grep -Ev '^(#.*|[[:space:]]*|[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*.*)$' config/dns-blocklist.txt | grep -v '^[[:space:]]*$'; then
            echo "ERROR: Invalid domain format in blocklist"
            exit 1
          fi
          
          echo "✓ DNS configuration files are valid"
      
      - name: Deploy DNS filters
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          SSH_KEY: ~/.ssh/vps_key
          SSH_PORT: ${{ secrets.VPS_SSH_PORT || '33003' }}
          SSH_USER: ${{ secrets.VPS_SSH_USER || 'deploy' }}
        run: |
          # Run deployment script
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "Running in DRY RUN mode..."
            ./scripts/deploy-dns.sh --host="$VPS_HOST" --ssh-key="$SSH_KEY" --ssh-port="$SSH_PORT" --ssh-user="$SSH_USER" --dry-run
          else
            ./scripts/deploy-dns.sh --host="$VPS_HOST" --ssh-key="$SSH_KEY" --ssh-port="$SSH_PORT" --ssh-user="$SSH_USER"
          fi
      
      - name: Verify deployment
        if: ${{ inputs.dry_run != true }}
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          SSH_PORT: ${{ secrets.VPS_SSH_PORT || '33003' }}
          SSH_USER: ${{ secrets.VPS_SSH_USER || 'deploy' }}
        run: |
          echo "Verifying AdGuard Home is running..."
          ssh -i ~/.ssh/vps_key -p "$SSH_PORT" "$SSH_USER@$VPS_HOST" \
            "sudo systemctl is-active --quiet adguardhome && echo '✓ AdGuard Home is running' || (echo 'ERROR: AdGuard Home is not running' && exit 1)"
      
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/vps_key
          rm -f ~/.ssh/config
